<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (c) 2009 Sebastiaan Deckers
    
    The use and distribution terms for this software are covered by the
    Common Public License 1.0 (http://opensource.org/licenses/cpl.php)
    which can be found in the file CPL.TXT at the root of this distribution.
    By using this software in any fashion, you are agreeing to be bound by
    the terms of this license.
    
    You must not remove this notice, or any other, from this software.
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<?include version.wxs ?>
	<Product
		Id="*"
		Language="1033"
		Manufacturer="$(var.Manufacturer)"
		Name="$(var.Name)"
		UpgradeCode="{9F661F94-F17F-4F5C-B1C8-2955C85C8FE9}"
		Version="$(var.Version)"
	>

		<!--
			Do not require administrative access to avoid UAC and problems for restricted users.
		-->
		<Package
			Id="*"
			Compressed="yes"
			InstallPrivileges="limited"
			InstallerVersion="200"
			InstallScope="perUser"
		/>
		<Media Cabinet="product.cab" EmbedCab="yes" Id="1"/>

		<!--
			Deploy the files generated by heat.exe and the shortcuts described below.
		-->
		<Feature Id="ProductFeature" Level="1" Title="Core Application">
			<ComponentGroupRef Id="CoreFiles"/>
			<ComponentRef Id="DesktopShortcut"/>
			<ComponentRef Id="StartMenuShortcut"/>
			<ComponentRef Id="StartupShortcut"/>
			<ComponentRef Id="RegistryCleanupHKCU"/>
			<ComponentRef Id="RegistryCleanupHKLM"/>
		</Feature>

		<Directory Id="TARGETDIR" Name="SourceDir">

			<!--
				Install the application in the current user's application data directory.
				This allows installation without administrative permissions which would
				otherwise be required to write in Program Files.
			-->
			<Directory Id="LocalAppDataFolder" Name="PFiles">
				<Directory Id="PandionLocalFiles" Name="$(var.SafeName)">
					<Directory Id="DESTINATION" Name="Application"/>
				</Directory>
			</Directory>

			<!--
				Shortcut on the desktop.
			-->
			<Directory Id="DesktopFolder">
				<Component Id="DesktopShortcut" Guid="{6d4436d8-88d8-42a5-9b4d-5d86d2f8dba1}">
					<Shortcut
						Id="DesktopShortcut" 
						Name="$(var.SafeName)"
						Description="Instant messenger for XMPP networks"
						Target="[DESTINATION]$(var.SafeName).exe"
						WorkingDirectory="DESTINATION"
					/>
					<RegistryValue
						Root="HKCU"
						Key="Software\$(var.SafeName)"
						Name="DesktopShortcut"
						Type="integer"
						Value="1"
						KeyPath="yes"
					/>
				</Component>
			</Directory>

			<!--
				Shortcut to in the Start Menu.
			-->
			<Directory Id="ProgramMenuFolder">
				<Component Id="StartMenuShortcut" Guid="{eee7fe7f-2a5d-4981-8d90-a67f2f74901d}">
					<Shortcut
						Id="StartMenuShortcut" 
						Name="$(var.SafeName)"
						Description="Instant messenger for XMPP networks"
						Target="[DESTINATION]$(var.SafeName).exe"
						WorkingDirectory="DESTINATION"
					/>
					<RegistryValue
						Root="HKCU"
						Key="Software\$(var.SafeName)"
						Name="StartMenuShortcut"
						Type="integer"
						Value="1"
						KeyPath="yes"
					/>
				</Component>
			</Directory>

			<!--
				Shortcut to launch on Windows startup.
			-->
			<Directory Id="StartupFolder">
				<Component Id="StartupShortcut" Guid="{5785b179-f2a2-4a9d-a9c1-0ae8e93651dc}">
					<Shortcut
						Id="StartupShortcut" 
						Name="$(var.SafeName)"
						Description="Instant messenger for XMPP networks"
						Target="[DESTINATION]$(var.SafeName).exe"
						WorkingDirectory="DESTINATION"
					/>
					<RegistryValue
						Root="HKCU"
						Key="Software\$(var.SafeName)"
						Name="StartupShortcut"
						Type="integer"
						Value="1"
						KeyPath="yes"
					/>
				</Component>
			</Directory>

		</Directory>

		<!--
			Allow administrative install to a common location for all users.
			Example: msiexec.exe /i $(var.SafeName).msi ALLUSERS=1
		-->
		<SetDirectory Id="LocalAppDataFolder" Sequence="both" Value="[ProgramFilesFolder]">
			ALLUSERS = 1
		</SetDirectory>

		<!--
			Remove older versions but do not overwrite newer versions.
		-->
		<Upgrade Id="{9F661F94-F17F-4F5C-B1C8-2955C85C8FE9}">
			<UpgradeVersion
				Property="OLDERVERSIONBEINGUPGRADED"
				Minimum="1.0.0"
				IncludeMinimum="yes"
				Maximum="$(var.Version)"
				IncludeMaximum="no"
			/>
		</Upgrade>
		<InstallExecuteSequence>
			<RemoveExistingProducts After="InstallValidate"/>
		</InstallExecuteSequence>

		<!--
			Locate and uninstall the old NSIS-based installer.
		-->
		<Property Id="FOUNDLEGACYUNINSTALLER">
			<RegistrySearch
				Id="LegacyUninstaller"
				Type="raw"
				Root="HKLM"
				Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.SafeName)"
				Name="UninstallString"
			/>
		</Property>
		<Property Id="QtExecCmdLine" Value="[FOUNDLEGACYUNINSTALLER] /S"/>
		<CustomAction Id="LaunchLegacyUninstaller" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="immediate" Return="ignore"/>
		<InstallExecuteSequence>
			<Custom Action="LaunchLegacyUninstaller" After="InstallInitialize">
				<![CDATA[FOUNDLEGACYUNINSTALLER AND (Not Installed) AND (NOT REMOVE)]]>
			</Custom>
		</InstallExecuteSequence>

		<!--
			User interface modifications and branding.
		-->
		<UIRef Id="WixUI_OneClick"/>
		<WixVariable Id="WixUIBannerBmp" Value="./banner.jpg"/>
		<WixVariable Id="WixUIDialogBmp" Value="./dialog.jpg"/>
		<WixVariable Id="WixUILicenseRtf" Value="./Temp/License.rtf"/>
		<Property Id="ARPHELPLINK" Value="$(var.AppHelpLink)"/>
		<Property Id="ARPURLINFOABOUT" Value="$(var.AppUrlInfoAbout)"/>

		<!--
			Launch the application from the Finish dialog or in auto-update mode.
			To run auto-update mode use the following command line:
			msiexec.exe /i $(var.SafeName).msi LAUNCHAPP=yes
		-->
		<Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch $(var.Name)"/>
		<Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
		<Property Id="WixShellExecTarget" Value="[DESTINATION]$(var.SafeName).exe"/>
		<CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes"/>
		<UI>
			<Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">
				WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed
			</Publish>
		</UI>
		<InstallExecuteSequence>
			<Custom Action="LaunchApplication" After="InstallFinalize">
				<![CDATA[LAUNCHAPP]]>
			</Custom>
		</InstallExecuteSequence>

		<!--
			Remove file/mime/uri registry associations that may have been created at runtime.
		-->
		<Component Id="RegistryCleanupHKCU" Directory="LocalAppDataFolder" Guid="{58642a78-00a3-4ba8-8335-7f299aa94db5}">
			<CreateFolder Directory="LocalAppDataFolder"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKCU" Key="Software\Classes\Applications\$(var.SafeName).exe"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKCU" Key="Software\Classes\$(var.SafeName).File.JISP"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKCU" Key="Software\Classes\$(var.SafeName).File.PDN"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKCU" Key="Software\Classes\$(var.SafeName).File.XMPP"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKCU" Key="Software\Classes\$(var.SafeName).Url.xmpp"/>
			<Condition>NOT LAUNCHAPP</Condition>
		</Component>
		<Component Id="RegistryCleanupHKLM" Directory="TARGETDIR" Guid="{dcd110c8-a3b5-4df0-9dbb-64ea3cc2bedb}">
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKLM" Key="Software\Classes\Applications\$(var.SafeName).exe"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKLM" Key="Software\Classes\$(var.SafeName).File.JISP"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKLM" Key="Software\Classes\$(var.SafeName).File.PDN"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKLM" Key="Software\Classes\$(var.SafeName).File.XMPP"/>
			<RemoveRegistryKey Action="removeOnUninstall" Root="HKLM" Key="Software\Classes\$(var.SafeName).Url.xmpp"/>
			<Condition>Privileged and (NOT LAUNCHAPP)</Condition>
		</Component>
	</Product>
</Wix>
